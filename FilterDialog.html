<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        padding: 12px;
      }
      textarea {
        width: 100%;
        height: 160px;
      }
      .row {
        margin-top: 8px;
      }
      button {
        padding: 8px 12px;
        margin-right: 8px;
        cursor: pointer;
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      .status {
        margin-top: 10px;
      }
      .spinner {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid #999;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
        margin-right: 6px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <h3>AI Auto Filter</h3>
    <div class="muted">
      Example: Revenues $5–$20M, Family = Yes, 20+ years, not Canada.
    </div>
    <div class="row">
      <textarea id="prompt" placeholder="Type your filter query here…">
<?= lastPrompt ?></textarea
      >
    </div>
    <div class="row">
      <button onclick="run()">Filter</button>
      <button onclick="runLast()">Run Last</button>
      <button onclick="clearFlags()">Clear Flags</button>
      <button onclick="showAll()">Show All</button>
    </div>
    <div id="status" class="status"></div>

    <script>
      function setStatus(msg, spin) {
        document.getElementById("status").innerHTML = spin
          ? '<span class="spinner"></span>' + msg
          : msg;
      }
      function run() {
        const prompt = document.getElementById("prompt").value.trim();
        if (!prompt) {
          setStatus("Please enter a filter query.");
          return;
        }
        setStatus("Filtering…", true);
        google.script.run
          .withSuccessHandler((res) => {
            setStatus(res.message || "Done.");
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + (err.message || err));
          })
          .AutoFilter_runAutoFilterFromClient(prompt);
      }
      function runLast() {
        setStatus("Running last filter…", true);
        google.script.run
          .withSuccessHandler((res) => {
            setStatus(res.message || "Done.");
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + (err.message || err));
          })
          .AutoFilter_runLastFilter();
      }
      function clearFlags() {
        setStatus("Clearing flags…", true);
        google.script.run
          .withSuccessHandler(() => {
            setStatus("AI flags cleared.");
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + (err.message || err));
          })
          .AutoFilter_clearFilterFlags();
      }
      function showAll() {
        setStatus("Removing sheet filter…", true);
        google.script.run
          .withSuccessHandler(() => {
            setStatus("All rows visible.");
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + (err.message || err));
          })
          .AutoFilter_removeSheetFilter();
      }
    </script>
  </body>
</html>
