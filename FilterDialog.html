<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 12px;
      }
      h2 {
        font-size: 18px;
        margin-top: 0;
      }
      textarea {
        width: 100%;
        height: 120px;
        font-size: 13px;
        resize: vertical;
      }
      button {
        margin: 4px 4px 4px 0;
        padding: 6px 12px;
      }
      #status {
        margin-top: 10px;
        font-size: 13px;
        color: #333;
        white-space: pre-wrap;
      }
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4285f4;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        display: inline-block;
        animation: spin 1s linear infinite;
        vertical-align: middle;
        margin-right: 6px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #progressBar {
        width: 100%;
        height: 10px;
        background: #ddd;
        border-radius: 5px;
        margin-top: 6px;
        overflow: hidden;
      }
      #progressFill {
        height: 100%;
        width: 0%;
        background: #4285f4;
        transition: width 0.3s ease;
      }
      .muted {
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <h2>AI Auto Filter</h2>
    <p style="font-size: 12px; color: #666">
      Example: <br />
      <code>Revenues $5–$20M, Family = Yes, 20+ years, not Canada.</code>
    </p>

    <textarea id="prompt" placeholder="Enter your filter query here...">
<?= lastPrompt ?></textarea
    >

    <div>
      <button id="btnRun" onclick="run()">Filter</button>
      <button id="btnClear" onclick="clearFlags()">Clear Flags</button>
      <button id="showFilteredBtn" onclick="showFiltered()">
        Show Filtered
      </button>
      <button id="btnShowAll" onclick="showAll()">Show All</button>
    </div>

    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="status">Ready.</div>

    <script>
      // ---- utilities ----
      function setStatus(msg, spin) {
        const el = document.getElementById("status");
        el.innerHTML = spin
          ? '<span class="spinner"></span>' + String(msg || "")
          : String(msg || "");
      }
      function updateProgress(percent) {
        document.getElementById("progressFill").style.width =
          (percent || 0) + "%";
      }
      function disableShowFiltered(disabled) {
        const b = document.getElementById("showFilteredBtn");
        if (b) b.disabled = !!disabled;
      }
      function setWorking(isBusy) {
        ["btnRun", "btnClear", "showFilteredBtn", "btnShowAll"].forEach(
          (id) => {
            const el = document.getElementById(id);
            if (el) el.disabled = !!isBusy;
          }
        );
      }
      function safeErr(e) {
        try {
          if (!e) return "Unknown error";
          if (typeof e === "string") return e;
          if (e.message) return e.message;
          // try a shallow stringify, guard circular
          return JSON.stringify(e, Object.getOwnPropertyNames(e));
        } catch (_) {
          return "Unknown error";
        }
      }

      // ---- actions ----
      function run() {
        const prompt = document.getElementById("prompt").value.trim();
        if (!prompt) {
          setStatus("Please enter a filter query.");
          return;
        }
        setStatus("Starting filter…", true);
        setWorking(true);
        disableShowFiltered(true);
        updateProgress(0);
        runBatch(prompt, 0);
      }

      function runBatch(prompt, batchIndex) {
        google.script.run
          .withSuccessHandler((res) => {
            updateProgress(res.progress || 0);
            setStatus(res.message, !res.done);
            if (!res.done) {
              runBatch(prompt, batchIndex + 1);
            } else {
              updateProgress(100);
              setStatus(res.message);
              disableShowFiltered(false);
              setWorking(false);
            }
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
            disableShowFiltered(false);
          })
          .AutoFilter_runAutoFilterBatch(prompt, batchIndex);
      }

      function clearFlags() {
        setStatus("Clearing flags…", true);
        updateProgress(0);
        setWorking(true);
        disableShowFiltered(true);
        google.script.run
          .withSuccessHandler((msg) => {
            updateProgress(0);
            setStatus(msg || "AI flags cleared.");
            setWorking(false);
            disableShowFiltered(true);
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
          })
          .AutoFilter_clearFilterFlags();
      }

      function showAll() {
        setStatus("Removing sheet filter…", true);
        updateProgress(0);
        setWorking(true);
        google.script.run
          .withSuccessHandler((msg) => {
            updateProgress(0);
            setStatus(msg || "All rows visible.");
            setWorking(false);
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
          })
          .AutoFilter_removeSheetFilter();
      }

      function showFiltered() {
        setStatus("Applying filtered view…", true);
        setWorking(true);
        google.script.run
          .withSuccessHandler((msg) => {
            setStatus(msg || "Showing filtered rows.");
            setWorking(false);
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
          })
          .AutoFilter_applyYesFilter();
      }
    </script>
  </body>
</html>
