<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      :root {
        --ok: #137333;
        --no: #a50e0e;
        --muted: #6b7280;
        --bar: #4285f4;
        --bg: #f3f4f6;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 12px;
      }
      h2 {
        font-size: 18px;
        margin-top: 0;
      }
      textarea {
        width: 100%;
        height: 120px;
        font-size: 13px;
        resize: vertical;
      }
      button {
        margin: 4px 4px 4px 0;
        padding: 6px 12px;
      }
      /* progress bar */
      #progressBar {
        width: 100%;
        height: 10px;
        background: #ddd;
        border-radius: 5px;
        margin-top: 8px;
        overflow: hidden;
      }
      #progressFill {
        height: 100%;
        width: 0%;
        background: var(--bar);
        transition: width 0.3s ease;
      }
      /* transient status */
      #status {
        margin-top: 6px;
        font-size: 13px;
        color: #333;
        white-space: pre-wrap;
      }
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--bar);
        border-radius: 50%;
        width: 12px;
        height: 12px;
        display: inline-block;
        animation: spin 1s linear infinite;
        vertical-align: middle;
        margin-right: 6px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* NEW: subtle progress note (different style than summary) */
      #progressNote {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        background: var(--bg);
        border-radius: 6px;
        padding: 6px 8px;
        display: inline-block;
      }

      /* Persistent summary beneath the bar – strong badges */
      #summary {
        margin-top: 8px;
        font-size: 13px;
        color: #111;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-weight: 600;
        margin-right: 6px;
      }
      .badge-ok {
        background: #e8f5e9;
        color: var(--ok);
        border: 1px solid #c9e7cf;
      }
      .badge-no {
        background: #fdecea;
        color: var(--no);
        border: 1px solid #f7c9c5;
      }
    </style>
  </head>
  <body>
    <h2>AI Auto Filter</h2>
    <p style="font-size: 12px; color: #666">
      Example:<br />
      <code>Revenues $5–$20M, Family = Yes, 20+ years, not Canada.</code>
    </p>

    <textarea id="prompt" placeholder="Enter your filter query here...">
<?= lastPrompt ?></textarea
    >

    <div>
      <button id="btnRun" onclick="run()">Filter</button>
      <button id="btnClear" onclick="clearFlags()">Clear Flags</button>
      <button id="showFilteredBtn" onclick="showFiltered()">
        Show Filtered
      </button>
      <button id="btnShowAll" onclick="showAll()">Show All</button>
    </div>

    <div id="progressBar"><div id="progressFill"></div></div>

    <!-- NEW: subtle per-run progress explanation -->
    <div id="progressNote"></div>

    <!-- Persistent summary that stays after actions (until flags cleared) -->
    <div id="summary"></div>

    <!-- Transient status line -->
    <div id="status">Ready.</div>

    <script>
      // ---------- utilities ----------
      function setStatus(msg, spin) {
        const el = document.getElementById("status");
        el.innerHTML = spin
          ? '<span class="spinner"></span>' + String(msg || "")
          : String(msg || "");
      }
      function updateProgress(p) {
        document.getElementById("progressFill").style.width = (p || 0) + "%";
      }
      function setProgressNote(filteredCount, progressPct) {
        const el = document.getElementById("progressNote");
        const pct = progressPct != null ? ` • ${progressPct}%` : "";
        if (filteredCount == null) {
          el.textContent = "";
          return;
        }
        el.textContent = `${filteredCount} filtered${pct}`;
      }
      function setSummary(yes, no, prefixText) {
        const s = document.getElementById("summary");
        if (yes == null && no == null) {
          s.textContent = "";
          return;
        }
        const pre = prefixText || "Filtering complete.";
        s.innerHTML = `${pre}
          <span class="badge badge-ok">✅ Yes: ${yes}</span>
          <span class="badge badge-no">❌ No: ${no}</span>`;
      }
      function disableShowFiltered(disabled) {
        const b = document.getElementById("showFilteredBtn");
        if (b) b.disabled = !!disabled;
      }
      function setWorking(busy) {
        ["btnRun", "btnClear", "showFilteredBtn", "btnShowAll"].forEach(
          (id) => {
            const el = document.getElementById(id);
            if (el) el.disabled = !!busy;
          }
        );
      }
      function safeErr(e) {
        try {
          if (!e) return "Unknown error";
          if (typeof e === "string") return e;
          if (e.message) return e.message;
          return JSON.stringify(e, Object.getOwnPropertyNames(e));
        } catch (_) {
          return "Unknown error";
        }
      }
      function refreshSummary() {
        google.script.run
          .withSuccessHandler(({ hasFlags, yes, no }) => {
            if (hasFlags) {
              setSummary(yes, no, "Last results:");
              disableShowFiltered(false);
            } else {
              setSummary(null, null);
              disableShowFiltered(true);
            }
          })
          .withFailureHandler(() => {})
          .AutoFilter_getFlagCounts();
      }

      // ---------- actions ----------
      function run() {
        const prompt = document.getElementById("prompt").value.trim();
        if (!prompt) {
          setStatus("Please enter a filter query.");
          return;
        }
        setStatus("Starting filter…", true);
        setWorking(true);
        disableShowFiltered(true);
        updateProgress(0);
        setProgressNote(null, null);
        runBatch(prompt, 0);
      }

      function runBatch(prompt, batchIndex) {
        google.script.run
          .withSuccessHandler((res) => {
            updateProgress(res.progress || 0);
            setStatus(res.message, !res.done);

            // NEW: live "X filtered" during run
            google.script.run
              .withSuccessHandler(({ yes }) => {
                setProgressNote(yes ?? 0, res.progress || 0);
              })
              .AutoFilter_getFlagCounts();

            if (!res.done) {
              runBatch(prompt, batchIndex + 1);
            } else {
              updateProgress(100);
              setStatus(res.message);
              setProgressNote(res.yes ?? 0, 100); // final count
              setSummary(res.yes ?? 0, res.no ?? 0, "Filtering complete.");
              disableShowFiltered(false);
              setWorking(false);
            }
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
            refreshSummary();
          })
          .AutoFilter_runAutoFilterBatch(prompt, batchIndex);
      }

      function clearFlags() {
        setStatus("Clearing flags…", true);
        updateProgress(0);
        setProgressNote(null, null);
        setWorking(true);
        disableShowFiltered(true);
        google.script.run
          .withSuccessHandler((msg) => {
            setStatus(msg || "AI flags cleared.");
            setSummary(null, null);
            setWorking(false);
            disableShowFiltered(true);
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
            refreshSummary();
          })
          .AutoFilter_clearFilterFlags();
      }

      function showAll() {
        setStatus("Removing sheet filter…", true);
        setWorking(true);
        google.script.run
          .withSuccessHandler((msg) => {
            setStatus(msg || "All rows visible.");
            setWorking(false);
            refreshSummary(); // keep summary if flags exist
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
            refreshSummary();
          })
          .AutoFilter_removeSheetFilter();
      }

      function showFiltered() {
        setStatus("Applying filtered view…", true);
        setWorking(true);
        google.script.run
          .withSuccessHandler((msg) => {
            setStatus(msg || "Showing filtered rows.");
            setWorking(false);
            refreshSummary(); // summary persists
          })
          .withFailureHandler((err) => {
            setStatus("Error: " + safeErr(err));
            setWorking(false);
            refreshSummary();
          })
          .AutoFilter_applyYesFilter();
      }

      // On open, restore summary + enable/disable “Show Filtered”
      refreshSummary();
    </script>
  </body>
</html>
