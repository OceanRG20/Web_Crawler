<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f5f5f5;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }

    .container{
      padding:16px 16px 14px 16px;
    }

    h2{
      text-align:center;
      font-size:18px;
      margin:6px 0 14px 0;
      font-weight:700;
    }

    label{
      font-size:12px;
      display:block;
      margin:8px 0 4px 0;
      color:#222;
    }

    select, textarea, input{
      width:100%;
      box-sizing:border-box;
      font-family: Arial, sans-serif;
      border:1px solid #c9c9c9;
      border-radius:4px;
      background:#fff;
    }

    select{
      height:30px;
      padding:2px 8px;
    }

    textarea{
      resize:vertical;
      padding:8px;
      line-height:1.35;
      font-size:12px;
      height:420px;
    }

    .buttons{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
    }

    button{
      padding:4px 10px;
      font-size:11px;
      border:1px solid #bdbdbd;
      border-radius:4px;
      background:#fff;
      cursor:pointer;
      min-width:72px;
    }

    button.primary{
      border-color:#1a73e8;
      background:#1a73e8;
      color:#fff;
    }

    button:disabled{
      opacity:0.55;
      cursor:default;
    }

    /* Status area */
    #statusWrap{
      margin-top:10px;
      min-height:22px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    #status{
      font-size:13px;
      font-weight:600;
      color:#137333;
      opacity:0;
      transition:opacity 120ms ease;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    #status.show{ opacity:1; }

    #spinner{
      width:14px;
      height:14px;
      border:2px solid #c6c6c6;
      border-top-color:#1a73e8;
      border-radius:50%;
      display:none;
      animation:spin 0.8s linear infinite;
      flex:0 0 auto;
    }
    #spinner.show{ display:inline-block; }

    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Quick Backfill box */
    .qb{
      margin-top:12px;
      background:#fff;
      border:1px solid #d9d9d9;
      border-radius:0;          /* square corners (per your request) */
      padding:10px;
    }
    .qbTitle{
      font-weight:700;
      font-size:12px;
      margin-bottom:6px;
    }
    .qbRow{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      margin:6px 0;
      flex-wrap:wrap;           /* prevents “hidden” overflow */
      cursor:pointer;
    }
    .qbLabel{
      min-width:92px;
      color:#222;
      font-weight:600;
    }
    .qbValue{
      font-weight:700;
      color:#111;
      flex:1;
      min-width:160px;
    }

    .rangeWrap{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
      flex-wrap:wrap;           /* prevents clipping */
    }
    .rangeWrap input{
      height:28px;
      padding:2px 8px;
      width:120px;              /* stable sizing */
      border-radius:0;          /* square corners */
    }
    .rangeWrap .to{
      width:auto;
      font-weight:700;
      color:#333;
    }

    .qbActions{
      margin-top:8px;
      display:flex;
      justify-content:flex-start;
    }
    .qbActions button{
      min-width:92px;
      border-radius:0;          /* square corners */
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Update Rule Backfill</h2>

    <label for="columnSelect">Column name</label>
    <select id="columnSelect"></select>

    <label for="promptBox">Current prompt (editable)</label>
    <textarea id="promptBox" placeholder="Edit the prompt here..."></textarea>
    <!-- Main buttons -->
    <div class="buttons">
      <button id="btnReturn" onclick="onReturn()">Return</button>
      <button id="btnSave" class="primary" onclick="onSave()">Save</button>
      <button id="btnClose" onclick="google.script.host.close()">Close</button>
    </div>

    <div id="statusWrap">
      <div id="spinner"></div>
      <div id="status"></div>
    </div>

    <!-- Quick Backfill -->
    <div class="qb">
      <div class="qbTitle">Quick Backfill</div>

      <div class="qbRow">
        <div class="qbLabel">Current Column:</div>
        <div class="qbValue" id="qbColName">—</div>
      </div>

      <div class="qbRow">
        <label style="display:flex; align-items:center; gap:8px; margin:0; font-weight:600;">
          <input id="allRowsChk" type="checkbox" style="width:auto; margin:0;">
          All rows
        </label>
      </div>

      <div class="qbRow">
        <div class="qbLabel">Row Range:</div>
        <div class="rangeWrap">
          <input id="fromRow" type="number" min="2" placeholder="From (>=2)">
          <div class="to">to</div>
          <input id="toRow" type="number" min="2" placeholder="To (>=2)">
        </div>
      </div>

      <div class="qbActions">
        <button id="btnApply" class="primary" onclick="onApply()">Apply</button>
      </div>
    </div>


  </div>

  <script>
    let lastLoadedPrompt = "";
    let hideTimer = null;

    function setBusy(isBusy, msg){
      const spinner = document.getElementById("spinner");
      const status = document.getElementById("status");
      const btnReturn = document.getElementById("btnReturn");
      const btnSave = document.getElementById("btnSave");
      const btnApply = document.getElementById("btnApply");

      if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }

      spinner.classList.toggle("show", !!isBusy);
      btnReturn.disabled = !!isBusy;
      btnSave.disabled = !!isBusy;
      btnApply.disabled = !!isBusy;

      if (msg){
        status.textContent = msg;
        status.classList.add("show");
        if (!isBusy){
          hideTimer = setTimeout(() => status.classList.remove("show"), 1000);
        }
      } else {
        status.textContent = "";
        status.classList.remove("show");
      }
    }

    function syncQuickBackfillLabel(){
      const col = document.getElementById("columnSelect").value || "—";
      document.getElementById("qbColName").textContent = col;
    }

    function loadColumns(){
      setBusy(true, "Loading…");
      google.script.run
        .withSuccessHandler(function(columns){
          const sel = document.getElementById("columnSelect");
          sel.innerHTML = "";

          (columns || []).forEach(function(col){
            const o = document.createElement("option");
            o.value = col;
            o.textContent = col;
            sel.appendChild(o);
          });

          if (columns && columns.length > 0){
            syncQuickBackfillLabel();
            loadPrompt();
          } else {
            setBusy(false, "No columns found.");
          }
        })
        .withFailureHandler(function(err){
          setBusy(false, "Load failed.");
          console.error(err);
        })
        .BF_getBackfillColumns();
    }

    function loadPrompt(){
      const col = document.getElementById("columnSelect").value;
      if (!col) return;

      setBusy(true, "Loading…");
      google.script.run
        .withSuccessHandler(function(text){
          lastLoadedPrompt = text || "";
          document.getElementById("promptBox").value = lastLoadedPrompt;
          setBusy(false, "Loaded.");
        })
        .withFailureHandler(function(err){
          setBusy(false, "Load failed.");
          console.error(err);
        })
        .BF_getBackfillPrompt(col);
    }

    function onReturn(){
      document.getElementById("promptBox").value = lastLoadedPrompt;
      setBusy(false, "Reverted.");
    }

    function onSave(){
      const col = document.getElementById("columnSelect").value;
      const text = document.getElementById("promptBox").value || "";
      if (!col) return;

      setBusy(true, "Saving…");
      google.script.run
        .withSuccessHandler(function(msg){
          lastLoadedPrompt = text || "";
          setBusy(false, msg || "Saved.");
        })
        .withFailureHandler(function(err){
          setBusy(false, "Save failed.");
          console.error(err);
        })
        .BF_saveBackfillPrompt(col, text);
    }

  function onApply(){
    const col = document.getElementById("columnSelect").value;
    const allRows = document.getElementById("allRowsChk").checked;

    if (!col){
      setBusy(false, "No column selected.");
      return;
    }

    // If All rows checked, ask server for the proper range and run
    if (allRows){
      setBusy(true, "Running backfill (all rows)…");
      google.script.run
        .withSuccessHandler(function(info){
          // info: { startRow, endRow }
          const startRow = info.startRow;
          const endRow = info.endRow;

          // reflect in UI
          document.getElementById("fromRow").value = startRow;
          document.getElementById("toRow").value = endRow;

          google.script.run
            .withSuccessHandler(function(res){
              const msg = (res && res.message) ? res.message : "Backfill done.";
              setBusy(false, msg);
            })
            .withFailureHandler(function(err){
              setBusy(false, "Backfill failed.");
              console.error(err);
            })
            .BF_quickBackfill(col, startRow, endRow);
        })
        .withFailureHandler(function(err){
          setBusy(false, "Range check failed.");
          console.error(err);
        })
        .BF_getMMCrawlDataRange();
      return;
    }

    // Manual range mode (existing behavior)
    const fromVal = parseInt(document.getElementById("fromRow").value, 10);
    const toVal = parseInt(document.getElementById("toRow").value, 10);

    if (!fromVal || !toVal || fromVal < 2 || toVal < 2){
      setBusy(false, "Row range must be >= 2.");
      return;
    }

    setBusy(true, "Running backfill…");
    google.script.run
      .withSuccessHandler(function(res){
        const msg = (res && res.message) ? res.message : "Backfill done.";
        setBusy(false, msg);
      })
      .withFailureHandler(function(err){
        setBusy(false, "Backfill failed.");
        console.error(err);
      })
      .BF_quickBackfill(col, fromVal, toVal);
  }

  // Auto-disable inputs when All rows is checked
document.addEventListener("DOMContentLoaded", function () {
    // ---- Elements ----
    const columnSelect = document.getElementById("columnSelect");
    const allRowsChk   = document.getElementById("allRowsChk");
    const fromRowInput = document.getElementById("fromRow");
    const toRowInput   = document.getElementById("toRow");

    // ---- Existing behavior: reload prompt when column changes ----
    if (columnSelect) {
      columnSelect.addEventListener("change", function () {
        loadPrompt();   // your existing function
      });
    }

    // ---- NEW: All rows checkbox behavior ----
    if (allRowsChk && fromRowInput && toRowInput) {
      allRowsChk.addEventListener("change", function () {
        const useAll = allRowsChk.checked;

        // Disable / enable manual inputs
        fromRowInput.disabled = useAll;
        toRowInput.disabled   = useAll;

        // Clear values when switching to "All rows"
        if (useAll) {
          fromRowInput.value = "";
          toRowInput.value   = "";
        }
      });
    }

    // ---- Initial load ----
    loadColumns(); // your existing function
  });
  </script>
</body>
</html>
