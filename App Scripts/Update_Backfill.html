<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f5f5f5;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }

    .container{
      padding:16px 16px 14px 16px;
    }

    h2{
      text-align:center;
      font-size:18px;
      margin:6px 0 14px 0;
      font-weight:700;
    }

    label{
      font-size:12px;
      display:block;
      margin:8px 0 4px 0;
      color:#222;
    }

    select, textarea{
      width:100%;
      box-sizing:border-box;
      font-family: Arial, sans-serif;
      border:1px solid #c9c9c9;
      border-radius:4px;
      background:#fff;
    }

    select{
      height:30px;
      padding:2px 8px;
    }

    textarea{
      resize:vertical;
      padding:8px;
      line-height:1.35;
      font-size:12px;
    }

    #promptBox{ height:360px; }
    #planBox{ height:110px; }

    .buttons{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
    }

    button{
      padding:4px 10px;
      font-size:11px;
      border:1px solid #bdbdbd;
      border-radius:4px;
      background:#fff;
      cursor:pointer;
      min-width:72px;
    }

    button.primary{
      border-color:#1a73e8;
      background:#1a73e8;
      color:#fff;
    }

    button:disabled{
      opacity:0.55;
      cursor:default;
    }

    #statusWrap{
      margin-top:10px;
      min-height:22px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    #status{
      font-size:13px;
      font-weight:600;
      color:#137333;
      opacity:0;
      transition:opacity 120ms ease;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    #status.show{ opacity:1; }

    #spinner{
      width:14px;
      height:14px;
      border:2px solid #c6c6c6;
      border-top-color:#1a73e8;
      border-radius:50%;
      display:none;
      animation:spin 0.8s linear infinite;
      flex:0 0 auto;
    }

    #spinner.show{ display:inline-block; }

    @keyframes spin{ to{ transform:rotate(360deg); } }

    .hint{
      font-size:11px;
      color:#444;
      margin-top:2px;
    }

    /* =========================
       Quick Backfill (Range UI)
       ========================= */
    .quickBox{
      margin-top:12px;
      background:#fff;
      border:1px solid #d9d9d9;
      border-radius:6px; /* square-ish but clean */
      padding:10px;
    }
    .quickTitle{
      font-size:12px;
      font-weight:700;
      margin:0 0 8px 0;
    }
    .quickRow{
      margin-bottom:8px;
    }
    .quickLabel{
      font-size:11px;
      color:#555;
      margin-bottom:3px;
    }
    .quickValue{
      font-size:12px;
      font-weight:600;
      color:#111;
      word-break:break-word;
      line-height:1.2;
    }
    .rangeRow{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:nowrap;
    }
    .rangeRow input{
      width:88px;
      padding:4px 6px;
      font-size:12px;
      border:1px solid #c9c9c9;
      border-radius:4px;
      box-sizing:border-box;
    }
    .rangeSep{
      font-size:12px;
      color:#555;
      flex:0 0 auto;
    }
    .applyBtn{
      padding:6px 12px;
      font-size:12px;
      border:none;
      border-radius:4px;
      background:#1a73e8;
      color:#fff;
      cursor:pointer;
      width:88px;
    }
    .applyBtn:hover{ background:#1666cc; }
    .applyBtn:disabled{ opacity:0.55; cursor:default; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Update Rule Backfill</h2>

    <label for="columnSelect">Column name</label>
    <select id="columnSelect"></select>

    <label for="promptBox">Current prompt (saved in Backfill)</label>
    <textarea id="promptBox" placeholder="Prompt..."></textarea>
    <div id="statusWrap">
      <div id="spinner"></div>
      <div id="status"></div>
    </div>
    <div class="grow">
      <label for="planBox">Please write your update plan (thinking rule)</label>
      <textarea id="planBox" placeholder="Write changes only. Example: enforce order site → calc → public. Ensure blanks stay blank..."></textarea>
      <div class="hint">Update (AI) will rewrite the prompt and SAVE it to Backfill automatically.</div>
    </div>

    <div class="buttons">
      <button id="btnReturn" onclick="onReturn()">Return</button>
      <button id="btnAiUpdate" class="primary" onclick="onAiUpdate()">Update (AI)</button>
      <button id="btnClose" onclick="google.script.host.close()">Close</button>
    </div>

    <!-- ✅ Quick Backfill Range Part -->
    <div class="quickBox">
      <div class="quickTitle">Quick Backfill</div>

      <div class="quickRow">
        <div class="quickLabel">Current column</div>
        <div class="quickValue" id="currentColumnLabel">—</div>
      </div>

      <div class="quickRow">
        <div class="quickLabel">Row range</div>
        <div class="rangeRow">
          <input type="number" id="rowFrom" min="2" placeholder="From (≥2)">
          <span class="rangeSep">to</span>
          <input type="number" id="rowTo" min="2" placeholder="To (≥2)">
        </div>
      </div>

      <button id="btnApply" class="applyBtn" onclick="onQuickApply()">Apply</button>
    </div>
  </div>

  <script>
    let lastLoadedPrompt = "";
    let hideTimer = null;

    function setBusy(isBusy, msg){
      const spinner = document.getElementById("spinner");
      const status = document.getElementById("status");
      const btnReturn = document.getElementById("btnReturn");
      const btnAiUpdate = document.getElementById("btnAiUpdate");
      const btnApply = document.getElementById("btnApply");

      if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }

      spinner.classList.toggle("show", !!isBusy);
      btnReturn.disabled = !!isBusy;
      btnAiUpdate.disabled = !!isBusy;
      btnApply.disabled = !!isBusy;

      if (msg){
        status.textContent = msg;
        status.classList.add("show");
        if (!isBusy){
          hideTimer = setTimeout(() => status.classList.remove("show"), 1000);
        }
      } else {
        status.textContent = "";
        status.classList.remove("show");
      }
    }

    function syncCurrentColumnLabel_(){
      const col = document.getElementById("columnSelect").value || "—";
      document.getElementById("currentColumnLabel").textContent = col;
    }

    function loadColumns(){
      setBusy(true, "Loading…");
      google.script.run
        .withSuccessHandler(function(columns){
          const sel = document.getElementById("columnSelect");
          sel.innerHTML = "";

          (columns || []).forEach(function(col){
            const o = document.createElement("option");
            o.value = col;
            o.textContent = col;
            sel.appendChild(o);
          });

          syncCurrentColumnLabel_();

          if (columns && columns.length > 0){
            loadPrompt();
          } else {
            setBusy(false, "No columns found.");
          }
        })
        .withFailureHandler(function(err){
          setBusy(false, "Load failed.");
          console.error(err);
        })
        .BF_getBackfillColumns();
    }

    function loadPrompt(){
      const col = document.getElementById("columnSelect").value;
      if (!col) return;

      syncCurrentColumnLabel_();
      setBusy(true, "Loading…");

      google.script.run
        .withSuccessHandler(function(text){
          lastLoadedPrompt = text || "";
          document.getElementById("promptBox").value = lastLoadedPrompt;
          setBusy(false, "Loaded.");
        })
        .withFailureHandler(function(err){
          setBusy(false, "Load failed.");
          console.error(err);
        })
        .BF_getBackfillPrompt(col);
    }

    function onReturn(){
      document.getElementById("planBox").value = "";
      loadPrompt();
      setBusy(false, "Reverted.");
    }

    function onAiUpdate(){
      const col = document.getElementById("columnSelect").value;
      const plan = document.getElementById("planBox").value || "";

      if (!col) return;
      if (!plan.trim()){
        setBusy(false, "Plan is empty.");
        return;
      }

      setBusy(true, "Updating via OpenAI…");
      google.script.run
        .withSuccessHandler(function(res){
          if (res && res.updatedPrompt !== undefined){
            lastLoadedPrompt = res.updatedPrompt || "";
            document.getElementById("promptBox").value = lastLoadedPrompt;
            document.getElementById("planBox").value = "";
          }
          setBusy(false, (res && res.message) ? res.message : "Updated and saved.");
        })
        .withFailureHandler(function(err){
          setBusy(false, "Update failed.");
          console.error(err);
        })
        .BF_aiRewriteAndSavePrompt(col, plan);
    }

    /* =========================
       Quick Backfill Apply
       Requires a server function:
         BF_quickBackfillApply(columnId, startRow, endRow)
       ========================= */
    function onQuickApply(){
      const col = document.getElementById("columnSelect").value;
      const from = parseInt(document.getElementById("rowFrom").value || "", 10);
      const to = parseInt(document.getElementById("rowTo").value || "", 10);

      if (!col){
        setBusy(false, "No column selected.");
        return;
      }
      if (!from || from < 2){
        setBusy(false, "From must be ≥ 2.");
        return;
      }
      if (!to || to < 2){
        setBusy(false, "To must be ≥ 2.");
        return;
      }

      const startRow = Math.min(from, to);
      const endRow = Math.max(from, to);

      setBusy(true, `Backfilling ${startRow}-${endRow}…`);
      google.script.run
        .withSuccessHandler(function(msg){
          setBusy(false, msg || "Backfill done.");
        })
        .withFailureHandler(function(err){
          setBusy(false, "Backfill failed.");
          console.error(err);
        })
        .BF_quickBackfillApply(col, startRow, endRow);
    }

    document.addEventListener("DOMContentLoaded", function(){
      const colSel = document.getElementById("columnSelect");
      colSel.addEventListener("change", function(){
        syncCurrentColumnLabel_();
        loadPrompt();
      });
      loadColumns();
    });
  </script>
</body>
</html>
